<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YouTube Music</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéµ</text></svg>">

</head>
<body>

    <div id="authSection" class="auth-screen hidden">
        <h1 style="font-size: 40px; margin-bottom: 10px;">Music Manager</h1>
        <p style="color: #b3b3b3; margin-bottom: 40px;">Your Unified Music Player</p>
        <button onclick="login()" style="padding: 15px 40px; font-size: 18px; border-radius: 50px; border: none; background: #1db954; color: white; cursor: pointer; font-weight: bold;">
            Login with Google
        </button>
    </div>

    <div id="appSection" class="main-layout hidden">
        
        <nav class="sidebar">
            <h2>üéµ Music</h2>
            <button class="nav-btn active" onclick="navigate('search')"><span class="nav-icon">üîç</span> Search</button>
            <button class="nav-btn" onclick="navigate('library')"><span class="nav-icon">üìö</span> My Library</button>
            <button class="nav-btn" onclick="navigate('settings')"><span class="nav-icon">‚öôÔ∏è</span> Settings</button>
            <button class="nav-btn" onclick="navigate('queue')"><span class="nav-icon">‚è≥</span> Queue</button>
            <div class="user-profile">
                <img id="userAvatar" class="user-avatar" src="">
                <span id="userName" style="font-size: 14px; font-weight: bold;">User</span>
                <button onclick="logout()" style="margin-left: auto; background: none; border: none; color: #b3b3b3; cursor: pointer;">Exit</button>
            </div>
        </nav>

        <main class="content">
            <div id="view-search" class="view-section active">
                <div class="search-bar-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="What do you want to play?" onkeypress="if(event.key === 'Enter') searchMusic()">
                </div>
                <div id="results"></div>
            </div>

            <div id="view-library" class="view-section">
                <h1 style="font-size: 32px; margin-bottom: 20px;">Your Library</h1>
                <div id="playlistGrid" class="playlist-grid"></div>
            </div>

            <div id="view-playlist-details" class="view-section">
                <button onclick="navigate('library')" style="background:none; border:none; color:#b3b3b3; cursor:pointer; margin-bottom: 20px;">‚Üê Back to Library</button>
                <div style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 30px;">
                    <img id="pl-cover" style="width: 200px; height: 200px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                    <div>
                        <span style="font-size: 14px; font-weight: bold;">PLAYLIST</span>
                        <h1 id="pl-title" style="font-size: 60px; margin: 10px 0;">Playlist Title</h1>
                        <p id="pl-desc" style="color: #b3b3b3;">Description</p>
                    </div>
                </div>
                <div id="playlist-tracks"></div>
            </div>
            <div id="view-queue" class="view-section">
            <h1 style="font-size: 32px; margin-bottom: 20px;">Current Queue</h1>
            <button onclick="clearQueue()" style="background:#333; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Clear Queue</button>
            <div id="queue-list" class="playlist-grid" style="display:block; margin-top:20px;">
                <p>Queue is empty.</p>
            </div>
        </div>
        </main>
    </div>

    <div id="playerContainer" class="player-footer hidden">
        
        <div class="mini-player-controls">
            
            <div class="player-info" style="width: 250px; display: flex; align-items: center; gap: 15px;">
                <img id="playerThumbnail" src="" style="width: 56px; height: 56px; border-radius: 4px;">
                <div style="overflow: hidden;">
                    <div id="playerTitle" style="font-weight: bold; white-space: nowrap;">Song Title</div>
                    <div style="font-size: 12px; color: #b3b3b3;">Artist Name</div>
                </div>
            </div>
            
            <div class="player-controls" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 5px;">
                    <button id="btnShuffle" onclick="playerManager.toggleShuffle()" style="background:none; border:none; color:#b3b3b3; cursor:pointer; font-size: 16px;" title="Shuffle">üîÄ</button>

                    <button id="btnPrev" onclick="playerManager.playPrevious()" style="background:none; border:none; color:white; cursor:pointer; font-size: 20px;" title="Previous">‚èÆ</button>
                    
                    <audio id="audioPlayer" style="display:none;"></audio> 
                    <button id="btnPlayPause" onclick="playerManager.togglePlay()" style="background:none; border:none; color:white; cursor:pointer; font-size: 35px;">‚ñ∂</button>
                    
                    <button id="btnNext" onclick="playerManager.playNext()" style="background:none; border:none; color:white; cursor:pointer; font-size: 20px;" title="Next">‚è≠</button>

                    <button id="btnRepeat" onclick="playerManager.toggleRepeat()" style="background:none; border:none; color:#b3b3b3; cursor:pointer; font-size: 16px; position:relative;" title="Repeat">
                        üîÅ
                        <span id="repeatOneBadge" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:10px; font-weight:bold; color:black;">1</span>
                    </button>
                </div>

                <div style="width: 100%; max-width: 500px; display: flex; align-items: center; gap: 10px; font-size: 12px; color: #b3b3b3;">
                    <span id="currentTime">0:00</span>
                    <input type="range" id="progressBar" value="0" min="0" max="100" step="1" style="flex: 1; cursor: pointer;">
                    <span id="totalTime">0:00</span>
                </div>
            </div>
            
            <div style="width: 250px; display: flex; align-items: center; justify-content: flex-end; gap: 15px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button id="btnMute" onclick="playerManager.toggleMute()" style="background:none; border:none; color:#b3b3b3; cursor:pointer; font-size: 18px;">üîä</button>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1" style="width: 80px;">
                </div>

                <button onclick="toggleExpand()" id="btnExpand" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px;">‚¨ú Expand</button>
            </div>
        </div>

        <div class="expanded-content">
            <div class="big-art-container">
                <img id="bigPlayerArt" class="big-art" src="">
            </div>
            <div class="queue-container">
                <h3 style="margin-top:0;">Up Next</h3>
                <div id="queue-list-expanded"></div>
            </div>
        </div>
    </div>
    

    <script src="/js/YouTubeAdapter.js"></script>
    <script src="/js/PlayerManager.js"></script>

    <script>
    // GLOBAL STATE 
    let userToken = localStorage.getItem('userToken');
    let refreshToken = localStorage.getItem('refreshToken');
    let playerManager; // FIXED: Only declare variable here, do not instantiate yet

    document.addEventListener('DOMContentLoaded', () => {
        console.log("üöÄ App Starting...");
        /// 1. Create Instance
        playerManager = new PlayerManager(); // FIXED: Instantiate inside DOMContentLoaded
        
        // 2. ‚úÖ Initialize UI (This connects the JS to the HTML)
        playerManager.init();
        const audioTag = document.getElementById('audioPlayer');
        const ytAdapter = new YouTubeAdapter(audioTag);
        playerManager.registerAdapter('youtube', ytAdapter);
        
        audioTag.onended = () => playerManager.playNext();

        // 2. Check Auth
        handleAuth();
    });

    // --- NAVIGATION ---
    function navigate(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        
        if (viewName === 'search') document.getElementById('view-search').classList.add('active');
        if (viewName === 'library') {
            document.getElementById('view-library').classList.add('active');
            loadPlaylists();
        }
        // NEW: Queue
        if (viewName === 'queue') {
            document.getElementById('view-queue').classList.add('active');
            if(playerManager) playerManager.renderQueue();
        }
        if (viewName === 'settings') alert("Settings coming soon!");

        // Update Buttons
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        if (event && event.target) {
            const btn = event.target.closest('button');
            if (btn) btn.classList.add('active');
        }
    }

    
    function clearQueue() {
        if(playerManager) {
            playerManager.queue = [];
            playerManager.renderQueue();
        }
    }

    
    function toggleExpand() {
        const container = document.getElementById('playerContainer');
        const btn = document.getElementById('btnExpand');

        // Toggle class
        container.classList.toggle('expanded');

        // Logic: If expanded class exists -> We are big -> Show "Minimize"
        if (container.classList.contains('expanded')) {
            btn.innerText = "‚ûñ Minimize";
        } else {
            btn.innerText = "‚¨ú Expand";
        }
    }  // --- AUTH ---
    function handleAuth() {
        const urlParams = new URLSearchParams(window.location.search);
        const newAccessToken = urlParams.get('access_token');
        const newRefreshToken = urlParams.get('refresh_token');

        if (newAccessToken) {
            localStorage.setItem('userToken', newAccessToken);
            userToken = newAccessToken;
            if (newRefreshToken) {
                localStorage.setItem('refreshToken', newRefreshToken);
                refreshToken = newRefreshToken;
            }
            window.history.replaceState({}, document.title, "/");
            showApp();
        } else if (userToken) {
            showApp();
        } else {
            document.getElementById('authSection').classList.remove('hidden');
        }
    }

    function showApp() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('appSection').classList.remove('hidden');
        fetchProfile();
    }

    function login() { window.location.href = '/auth/google'; }
    function logout() {
        localStorage.removeItem('userToken');
        localStorage.removeItem('refreshToken');
        location.reload();
    }

    // --- API HELPER (FIXED) ---
    async function authorizedFetch(url, options = {}) {
        if (!options.headers) options.headers = {};
        
        // ‚úÖ FIX: Send Bearer Token correctly
        if (userToken) {
            options.headers['Authorization'] = `Bearer ${userToken}`;
        }

        let response = await fetch(url, options);

        // Auto-Refresh Logic
        if (response.status === 401 && refreshToken) {
            console.log("Token expired. Refreshing...");
            const refreshRes = await fetch('/auth/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh_token: refreshToken })
            });

            if (refreshRes.ok) {
                const data = await refreshRes.json();
                userToken = data.access_token;
                localStorage.setItem('userToken', userToken);
                
                // Retry with new token
                options.headers['Authorization'] = `Bearer ${userToken}`;
                response = await fetch(url, options);
            } else {
                logout();
            }
        }
        return response;
    }

    // --- DATA FUNCTIONS ---
    async function fetchProfile() {
        try {
            const res = await authorizedFetch('/auth/me');
            if (!res.ok) return;
            const data = await res.json();
            if (data.name) document.getElementById('userName').innerText = data.name;
            if (data.picture) document.getElementById('userAvatar').src = data.picture;
        } catch (e) { console.error(e); }
    }

    async function searchMusic() {
        const query = document.getElementById('searchInput').value;
        const container = document.getElementById('results');
        container.innerHTML = '<p>Searching...</p>';
        try {
            const res = await authorizedFetch(`/search?q=${query}`);
            const data = await res.json();
            renderList(data.items || [], container);
        } catch (err) {
            container.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
        }
    }

    async function loadPlaylists() {
        const grid = document.getElementById('playlistGrid');
        grid.innerHTML = '<p>Loading...</p>';
        try {
            const res = await authorizedFetch('/playlist/lists');
            const playlists = await res.json();
            grid.innerHTML = '';
            
            // Inject "Liked Videos" Card manually
            const likedCard = document.createElement('div');
            likedCard.className = 'playlist-card';
            likedCard.onclick = () => openLikedVideos();
            likedCard.innerHTML = `
                <div style="width:100%; aspect-ratio:1; background:linear-gradient(45deg,#4e00b8,#8f00b8); border-radius:4px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; font-size:40px;">üíú</div>
                <h3>Liked Songs</h3><p>Auto-generated</p>
            `;
            grid.appendChild(likedCard);

            if (Array.isArray(playlists)) {
                playlists.forEach(pl => {
                    if(pl.snippet.title === 'Like' && pl.contentDetails.itemCount === 0) return; // Ghost filter
                    const card = document.createElement('div');
                    card.className = 'playlist-card';
                    card.onclick = () => openPlaylist(pl.id, pl.snippet.title, pl.snippet.thumbnails?.medium?.url);
                    card.innerHTML = `<img src="${pl.snippet.thumbnails?.medium?.url}"><h3>${pl.snippet.title}</h3><p>${pl.contentDetails.itemCount} Songs</p>`;
                    grid.appendChild(card);
                });
            }
        } catch (err) { console.error(err); }
    }

    async function openPlaylist(id, title, img) {
        setupPlaylistView(title, img);
        try {
            const res = await authorizedFetch(`/playlist/lists/${id}`);
            const tracks = await res.json();
            renderList(tracks, document.getElementById('playlist-tracks'));
            document.getElementById('pl-desc').innerText = `${tracks.length} Songs`;
        } catch(e) { console.error(e); }
    }

    async function openLikedVideos() {
        setupPlaylistView("Liked Songs", "https://t.scdn.co/images/3099b3803ad9496896c43f22fe9be8c4.jpeg");
        try {
            const res = await authorizedFetch('/playlist/mine');
            const tracks = await res.json();
            renderList(tracks, document.getElementById('playlist-tracks'));
            document.getElementById('pl-desc').innerText = `${tracks.length} Songs`;
        } catch(e) { console.error(e); }
    }

    function setupPlaylistView(title, img) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-playlist-details').classList.add('active');
        document.getElementById('pl-title').innerText = title;
        document.getElementById('pl-cover').src = img || '';
        document.getElementById('pl-desc').innerText = "Loading...";
        document.getElementById('playlist-tracks').innerHTML = '';
    }

function renderList(items, container) {
        container.innerHTML = '';
        if(!items || items.length === 0) { container.innerHTML = '<p>No results.</p>'; return; }
        
        items.forEach(item => {
            const snip = item.snippet || {}; 
            const videoId = item.id?.videoId || item.id || snip.resourceId?.videoId;
            const title = item.title || snip.title;
            const artist = item.artist || snip.channelTitle;
            const img = item.image || snip.thumbnails?.default?.url;
            
            if (!videoId) return;
            const safeTitle = title.replace(/'/g, "\\'");
            const safeArtist = artist.replace(/'/g, "\\'");
            
            const div = document.createElement('div');
            div.className = 'result-item';
            div.innerHTML = `
                <img src="${img}">
                <div class="result-info"><strong>${title}</strong><br><small>${artist}</small></div>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn-play" onclick="playSong('${videoId}', '${safeTitle}', '${img}', '${safeArtist}')">‚ñ∂</button>
                    
                    <button class="nav-btn" style="width:auto; padding:5px 10px; background:#333;" onclick="addToQueue('${videoId}', '${safeTitle}', '${img}', '${safeArtist}')" title="Add to Queue">+</button>
                    
                    <button class="nav-btn" style="width:auto; padding:5px 10px; background:transparent; color: #1db954;" onclick="likeVideo('${videoId}', this)" title="Like Song">‚ô•</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // --- BRIDGE FUNCTIONS ---
    function updatePlayerUI(title, img, artist) {
        // Small Player
        document.getElementById('playerTitle').innerText = title;
        document.getElementById('playerThumbnail').src = img;
        
        // Big Player
        const bigArt = document.getElementById('bigPlayerArt');
        if (bigArt) bigArt.src = img;

        // Show player if hidden
        document.getElementById('playerContainer').classList.remove('hidden');
    }

    // Update playSong bridge
    function playSong(id, title, img, artist) {
        updatePlayerUI(title, img, artist); // <--- Update UI immediately
        playerManager.play({ id, title, image: img, artist, source: 'youtube' });
    }
    function addToQueue(id, title, img, artist) {
        playerManager.addToQueue({ id, title, image: img, artist, source: 'youtube' });
        const btn = event.target;
        btn.innerText = "‚úÖ"; setTimeout(() => btn.innerText = "+", 1000);
    }
    function closePlayer() { 
        if(playerManager.currentAdapter) playerManager.currentAdapter.stop();
        document.getElementById('playerContainer').style.display = 'none';
    }

  
async function likeVideo(videoId, btn) {
    console.log(`[Frontend] User clicked like for: ${videoId}`);

    // 1. Visual Feedback (Immediate)
    const originalContent = btn.innerHTML;
    btn.innerHTML = "‚è≥";
    btn.disabled = true;

    try {
        // 2. Send Request to YOUR Server
        const res = await authorizedFetch('/playlist/like', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // ‚úÖ CRITICAL: Verify this JSON structure matches what the backend expects
            body: JSON.stringify({ videoId: videoId }) 
        });

        console.log(`[Frontend] Server responded: ${res.status}`);

        if (res.ok) {
            // 3. Success
            btn.innerHTML = "‚ù§Ô∏è";
            btn.style.color = "#1db954";
            btn.title = "Liked";
        } else {
            throw new Error("Server rejected the like request");
        }
    } catch (e) {
        console.error("[Frontend] Error:", e);
        // 4. Revert UI on Fail
        btn.innerHTML = "‚ùå";
        setTimeout(() => { 
            btn.innerHTML = originalContent; 
            btn.disabled = false; 
            btn.style.color = ""; 
        }, 2000);
    }
}

    </script>
</body>
</html>