<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YouTube Music</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéµ</text></svg>">
    <style>
        /* Modern Dark Theme */
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #121212; color: #fff; }
        h1, h3 { color: #1db954; }
        button { cursor: pointer; padding: 10px 15px; border-radius: 20px; border: none; font-weight: bold; transition: 0.2s; }
        button:hover { transform: scale(1.05); }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; background: #282828; padding: 15px; border-radius: 8px; }
        input { flex-grow: 1; padding: 10px; border-radius: 20px; border: none; background: #121212; color: white; }
        
        /* Results Grid */
        #results { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .result-item { background: #181818; padding: 15px; border-radius: 8px; text-align: center; }
        .result-item img { width: 100%; border-radius: 4px; margin-bottom: 10px; }
        .btn-play { background-color: #1db954; color: white; margin-right: 5px; }
        .btn-like { background-color: #282828; color: white; border: 1px solid #fff; }
        .btn-like.liked { background-color: #e91e63; border-color: #e91e63; }

        /* Login Screen */
        #authSection { text-align: center; margin-top: 100px; }
        .google-btn { background-color: #DB4437; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 15px 30px; font-size: 16px; margin: 0 auto; }
        #playerContainer {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.95);
        z-index: 1000;
        display: flex;
        flex-direction: column; /* Stack items vertically */
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease-in-out; /* Smooth animation */
        padding: 20px;
    }

    /* Art Box (Thumbnail) */
    #playerArtBox {
        width: 80%;
        max-width: 600px;
        aspect-ratio: 16/9;
        background: #000;
        border: 2px solid #333;
        margin-bottom: 20px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    #playerThumbnail {
        width: 100%; height: 100%; object-fit: cover; opacity: 0.8;
    }

    /* Text Info */
    #playerTitle {
        color: white; margin: 0 0 20px 0; text-align: center;
        transition: all 0.3s ease;
    }

    /* Audio Player */
    #audioPlayer {
        width: 80%; max-width: 800px; margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    /* Window Controls (Min/Close) */
    #windowControls {
        display: flex; gap: 15px;
    }
    .win-btn {
        padding: 10px 20px;
        background: #333; color: white; border: 1px solid #555;
        cursor: pointer; border-radius: 20px; font-size: 16px;
    }
    .win-btn:hover { background: #555; }


    /* --- MINIMIZED STATE (The Bottom Bar) --- */
    #playerContainer.minimized {
        top: auto; /* Release from top */
        bottom: 0; /* Stick to bottom */
        height: 90px; /* Fixed height bar */
        flex-direction: row; /* Horizontal layout */
        justify-content: space-between;
        background: #1a1a1a;
        border-top: 1px solid #444;
        padding: 0 20px;
    }

    /* Shrink the Art */
    #playerContainer.minimized #playerArtBox {
        width: 60px; height: 60px;
        margin-bottom: 0;
        border: none;
        aspect-ratio: 1/1; /* Square thumbnail */
    }

    /* Adjust the Title */
    #playerContainer.minimized #playerTitle {
        font-size: 14px;
        margin: 0 15px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }

    /* Adjust Audio Bar */
    #playerContainer.minimized #audioPlayer {
        width: 40%;
        margin-bottom: 0;
        height: 40px;
    }
    
    /* Hide the "Hidden" class strictly */
    .hidden { display: none !important; }
    </style>
</head>
<body>
<script src="/js/YouTubeAdapter.js"></script>
<script src="/js/PlayerManager.js"></script>
<div id="authSection">
    <img src="/logo.png" alt="Music Manager Logo" style="width: 150px; margin-bottom: 20px;">
    
    <p>Sign in to your YouTube account to use YouTube Music</p>
    <a href="/auth/login" style="text-decoration: none;">
        <button class="google-btn">Sign in with Google</button>
    </a>
</div>

<div id="appSection" class="hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px;">
        
        <div style="display: flex; align-items: center; gap: 10px;">
            <img src="/logo.png" alt="Logo" style="height: 40px; width: auto;">
            <h2 style="margin: 0;">Library</h2>
        </div>

        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="text-align: right;">
                <span id="userName" style="font-weight: bold; display: block;">User</span>
                <small onclick="logout()" style="color: #bbb; cursor: pointer;">Logout</small>
            </div>
            <img id="userAvatar" src="" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #1db954; display: none;">
        </div>
    </div>
    
  

        <div class="input-group">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search for songs..." 
                style="padding: 10px; width: 300px;"
                onkeydown="if(event.key === 'Enter') searchMusic()"
                >
            <button style="background: #e91e63; color: white;" onclick="loadLibrary()">My Likes</button>
        </div>
<div id="playerContainer" class="hidden">
    
    <div id="playerArtBox">
        <img id="playerThumbnail" src="">
        <div id="playerLoading" style="position: absolute; color: white; font-weight: bold;">
            Loading...
        </div>
    </div>

    <h2 id="playerTitle">Song Title</h2>

    <audio id="audioPlayer" controls></audio>

        <div id="windowControls">
            <button id="btnNext" class="win-btn" onclick="playNext()">‚è≠ Next</button>
            
            <button id="btnMin" class="win-btn" onclick="toggleMinimize()">‚ûñ Minimize</button>
            
            <button id="btnClose" class="win-btn" onclick="closePlayer()">‚úñ Close</button>
        </div>

</div>
        <div id="results"></div>
    </div>

   <script>
    // --- GLOBAL STATE ---
    let songQueue = []; // Holds the current song queue
    // GLOBAL VARIABLES
    let userToken = localStorage.getItem('userToken');
    let refreshToken = localStorage.getItem('refreshToken');

    // --- 1. INITIALIZATION ---
    const playerManager = new PlayerManager();  
    const audioTag = document.getElementById('audioPlayer');
    const ytAdapter = new YouTubeAdapter(audioTag);

    playerManager.registerAdapter('youtube', ytAdapter);

    // 2. PARSE URL TO GET TOKENS (This was missing!)
    const urlParams = new URLSearchParams(window.location.search);
    const newAccessToken = urlParams.get('access_token');
    const newRefreshToken = urlParams.get('refresh_token');

    // SCENARIO A: Just returned from Login (We have tokens in URL)
    if (newAccessToken) {
        console.log("Found tokens in URL, logging in...");
        
        localStorage.setItem('userToken', newAccessToken);
        userToken = newAccessToken; // Update global variable
        
        if (newRefreshToken) {
            localStorage.setItem('refreshToken', newRefreshToken);
            refreshToken = newRefreshToken;
        }

        // Remove tokens from URL so they don't look messy
        window.history.replaceState({}, document.title, "/");
        
        showApp();
    } 
    // SCENARIO B: Opening app (tokens already saved in LocalStorage)
    else if (userToken) {
        console.log("Found saved tokens, loading app...");
        showApp();
    } 
    // SCENARIO C: Not logged in
    else {
        console.log("No tokens found. Showing login screen.");
        document.getElementById('authSection').classList.remove('hidden');
    }

    function showApp() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('appSection').classList.remove('hidden');
        
        // Try to load data. If it fails, the helper will handle the refresh.
        fetchProfile();
    }

    // --- 2. SMART FETCH HELPER  ---
    // This function wraps our API calls. If a call fails because the token is expired,
    // it automatically pauses, refreshes the token, and tries again.
    async function authorizedFetch(url, options = {}) {
        // Attach current token
        if (!options.headers) options.headers = {};
        options.headers['Authorization'] = userToken;

        let response = await fetch(url, options);

        // IF request failed (401 Unauthorized) AND we have a refresh token...
        if (response.status === 401 && refreshToken) {
            console.log("Token expired! Attempting refresh...");
            
            // 1. Ask Backend for new token
            const refreshRes = await fetch('/auth/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh_token: refreshToken })
            });

            if (refreshRes.ok) {
                const data = await refreshRes.json();
                console.log("Token refreshed successfully!");
                
                // 2. Save new token
                userToken = data.access_token;
                localStorage.setItem('userToken', userToken);
                
                // 3. Retry original request with new token
                options.headers['Authorization'] = userToken;
                response = await fetch(url, options);
            } else {
                console.log("Refresh failed. User must log in again.");
                logout();
            }
        }

        return response;
    }

    // --- 3. CORE FUNCTIONS (Updated to use authorizedFetch) ---

    async function fetchProfile() {
        try {
            // Use authorizedFetch instead of fetch
            const res = await authorizedFetch('/auth/me');
            
            if (!res.ok) return; // Silent fail if still unauthorized
            
            const data = await res.json();
            if (data.name) document.getElementById('userName').innerText = data.name;
            if (data.picture) {
                const img = document.getElementById('userAvatar');
                img.src = data.picture;
                img.style.display = 'block';
            }
        } catch (error) {
            console.error("Profile load error", error);
        }
    }

    async function searchMusic() {
        const query = document.getElementById('searchInput').value;
        renderResults([], "Loading...");

        try {
            // Use authorizedFetch
            const res = await authorizedFetch(`/search?q=${query}`);
            const data = await res.json();
            
            if (!res.ok) throw new Error(data.error || "Search Failed");
            renderResults(data.items || [], "No results found.");
        } catch (err) {
            console.error(err);
            document.getElementById('results').innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
        }
    }

    async function loadLibrary() {
        renderResults([], "Loading Likes...");
        try {
            // Use authorizedFetch
            const res = await authorizedFetch('/playlist/mine');
            
            if (!res.ok) throw new Error("Could not load library");
            const data = await res.json();
            
            renderResults(data, "No liked videos found.", true);
        } catch (err) {
            console.error(err);
        }
    }

    async function likeVideo(videoId, btn) {
        btn.innerText = "...";
        try {
            // Use authorizedFetch
            const res = await authorizedFetch('/playlist/like', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ videoId })
            });

            if (res.ok) {
                btn.innerText = "‚úî Liked";
                btn.classList.add('liked');
                btn.disabled = true;
            } else {
                throw new Error("Failed");
            }
        } catch (err) {
            console.error(err);
            btn.innerText = "Error";
        }
    }

    // ... (Keep renderResults, playSong, logout) ...
    function renderResults(items, emptyMsg, isLibrary = false) {
        const container = document.getElementById('results');
        container.innerHTML = '';
        if (!items || items.length === 0) {
            container.innerHTML = `<p>${emptyMsg}</p>`;
            return;
        }
        items.forEach(item => {
            const snip = item.snippet;
            if (!snip) return;
            const videoId = isLibrary ? snip.resourceId.videoId : item.id.videoId;
            if(!videoId) return;
                const thumbUrl = snip.thumbnails.high?.url || snip.thumbnails.medium?.url || snip.thumbnails.default.url;
                const safeTitle = snip.title.replace(/'/g, "\\'"); 
                const safeArtist = snip.channelTitle.replace(/'/g, "\\'");

        const card = document.createElement('div');
        card.className = 'result-item';
        card.innerHTML = `
            <img src="${thumbUrl}">
            <strong>${snip.title}</strong><br>
            <small>${snip.channelTitle}</small><br><br>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="btn-play" onclick="playSong('${videoId}', '${safeTitle}', '${thumbUrl}', '${safeArtist}')" style="flex: 1;">
                ‚ñ∂ Play
            </button>

            <button class="btn-queue" onclick="addToQueue('${videoId}', '${safeTitle}', '${thumbUrl}', '${safeArtist}')" style="flex: 1; background: #444; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 4px;">
                + Queue
            </button>
            </div>
            ${!isLibrary ? `<button class="btn-like" onclick="likeVideo('${videoId}', this)">Like</button>` : ''}
        `;
            container.appendChild(card);
        });
    }
function toggleMinimize() {
    const container = document.getElementById('playerContainer');
    const minBtn = document.getElementById('btnMin'); // <--- TARGET BY ID
    
    // Toggle the class
    container.classList.toggle('minimized');

    // Update Button Text logic
    if (container.classList.contains('minimized')) {
        minBtn.innerText = "‚¨ú Expand";
    } else {
        minBtn.innerText = "‚ûñ Minimize";
    }
}

function playSong(videoId, title, thumbnailUrl, artist) {
    // Create a standardized "Track" object
    const track = {
        id: videoId,
        title: title,
        artist: artist,
        image: thumbnailUrl,
        source: 'youtube' // Explicitly mark this as a YouTube track
    };
    playerManager.play(track);
}
function closePlayer() {
    const container = document.getElementById('playerContainer');
    const audio = document.getElementById('audioPlayer');
    audio.pause();
    audio.src = ""; // Stop buffering
    container.classList.add('hidden');
    container.style.display = 'none';
}

    function logout() {
        if(userToken) fetch(`https://oauth2.googleapis.com/revoke?token=${userToken}`, { mode: 'no-cors' });
        localStorage.removeItem('userToken');
        localStorage.removeItem('refreshToken');
        location.reload();
    }

function addToQueue(videoId, title, thumbnail, artist) {
    const track = {
        id: videoId,
        title: title,
        artist: artist,
        image: thumbnail,
        source: 'youtube'
    };
    playerManager.addToQueue(track);
    
    // Simple Button Feedback
    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = "‚úÖ";
    setTimeout(() => btn.innerText = oldText, 1000);
}

function playNext() {
    playerManager.playNext();
}

// Listen for Song End (Auto-Play)
audioTag.onended = () => {
    console.log("Track finished.");
    playerManager.playNext();
};
</script>
</body>
</html>
